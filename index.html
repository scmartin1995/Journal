<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Journal</title>
<link rel="manifest" href="manifest.json">
<style>
body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
header { background: #1976d2; color: white; padding: 1rem; text-align: center; }
main { padding: 1rem; }
button { background: #1976d2; color: white; border: none; padding: 1rem; font-size: 1.2rem; margin: 0.5rem; border-radius: 8px; }
audio { width: 100%; margin-top: 1rem; }
input, textarea { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
</style>
</head>
<body>
<header>
<h1>Audio Journal</h1>
</header>
<main id="app"></main>
<script>
let db;
const request = indexedDB.open("audioJournalDB", 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("entries")){
    db.createObjectStore("entries", { keyPath: "id" });
  }
  if(!db.objectStoreNames.contains("config")){
    db.createObjectStore("config", { keyPath: "key" });
  }
};
request.onsuccess = e => { db = e.target.result; init(); };

function init(){
  const app = document.getElementById('app');
  const tx = db.transaction("config", "readonly");
  const store = tx.objectStore("config");
  store.get("pinHash").onsuccess = e => {
    const pinHash = e.target.result ? e.target.result.value : null;
    if(!pinHash){ setPINUI(app); } else { loginUI(app, pinHash); }
  };
}

function setPINUI(app){
  app.innerHTML = '<h2>Set PIN</h2><input type="password" id="pin"><button id="savePin">Save PIN</button>';
  document.getElementById('savePin').onclick = async () => {
    const pin = document.getElementById('pin').value;
    const hash = await hashPIN(pin);
    const tx = db.transaction("config", "readwrite");
    tx.objectStore("config").put({ key: "pinHash", value: hash });
    tx.oncomplete = () => init();
  };
}

function loginUI(app, pinHash){
  app.innerHTML = '<h2>Enter PIN</h2><input type="password" id="pin"><button id="login">Login</button>';
  document.getElementById('login').onclick = async () => {
    const pin = document.getElementById('pin').value;
    const hash = await hashPIN(pin);
    if(hash === pinHash){ journalUI(app); } else { alert("Wrong PIN"); }
  };
}

function journalUI(app){
  app.innerHTML = '<button id="recordBtn">üéôÔ∏è Record</button><div id="entries"></div>';
  const recordBtn = document.getElementById('recordBtn');
  let mediaRecorder, chunks = [];
  recordBtn.onclick = async () => {
    if(recordBtn.dataset.recording === "true"){
      mediaRecorder.stop();
      recordBtn.textContent = "üéôÔ∏è Record";
      recordBtn.dataset.recording = "false";
    } else {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/wav' });
        chunks = [];
        const id = Date.now();
        const entry = { id, timestamp: new Date().toISOString(), audio: blob };
        const tx = db.transaction("entries", "readwrite");
        tx.objectStore("entries").put(entry);
        tx.oncomplete = () => loadEntries();
      };
      mediaRecorder.start();
      recordBtn.textContent = "‚èπ Stop";
      recordBtn.dataset.recording = "true";
    }
  };
  loadEntries();
}

function loadEntries(){
  const tx = db.transaction("entries", "readonly");
  const store = tx.objectStore("entries");
  const req = store.getAll();
  req.onsuccess = e => {
    const entries = e.target.result;
    const list = document.getElementById('entries');
    list.innerHTML = '';
    entries.sort((a,b)=>b.id-a.id).forEach(ent => {
      const url = URL.createObjectURL(ent.audio);
      const div = document.createElement('div');
      div.innerHTML = '<p>'+ent.timestamp+'</p><audio controls src="'+url+'"></audio>';
      list.appendChild(div);
    });
  };
}

async function hashPIN(pin){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(pin));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>
</body>
</html>
